#!/usr/bin/env python

# Authors:
#   Jason Gerard DeRose <jderose@jasonderose.org>
#
# media: distributed media library
# Copyright (C) 2010 Jason Gerard DeRose <jderose@jasonderose.org>
#
# This file is part of `media`.
#
# `media` is free software: you can redistribute it and/or modify it under the
# terms of the GNU Lesser General Public License as published by the Free
# Software Foundation, either version 3 of the License, or (at your option) any
# later version.
#
# `media` is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more
# details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with `media`.  If not, see <http://www.gnu.org/licenses/>.


import sys
import os
from os import path
import optparse
import medialib
from medialib.filestore import FileStore
from medialib.metastore import MetaStore
from medialib.extractor import extract

args = sys.argv[1:]

base = args[0]
extensions = frozenset(a.lower() for a in args[1:])


store = FileStore()
db = MetaStore()


buf = []
for (action, filename, key) in store.add_recursive(args[0], extensions):
    print '  %s %r' % (action, filename)
    if not db.db.record_exists(key):
        meta = dict(
            extract(filename, ('_id', key))
        )
        buf.append(db.new(meta))
    if len(buf) >= 100:
        print 'adding %d' % len(buf)
        db.db.put_records_batch(buf)
        buf = []

if buf:
    print 'adding %d' % len(buf)
    db.db.put_records_batch(buf)
